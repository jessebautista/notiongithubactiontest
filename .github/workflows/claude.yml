# .github/workflows/claude.yml
name: Claude Code Generator

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned] # Issue 'opened' is the key one for notion-sync
  pull_request_review:
    types: [submitted]
  workflow_dispatch: # Keep manual dispatch for testing

jobs:
  claude-generate: # Renamed job for clarity
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event.name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (
        github.event_name == 'issues' && # When an issue event occurs
        (github.event.action == 'opened' || github.event.action == 'assigned') && # And it's opened or assigned
        (
          contains(github.event.issue.body, '@claude') || # EITHER it contains @claude in the body
          contains(github.event.issue.title, '@claude') || # OR it contains @claude in the title
          ( # OR it has both specific labels (if @claude in body/title is optional/fails)
            contains(github.event.issue.labels.*.name, 'auto-generated') &&
            contains(github.event.issue.labels.*.name, 'notion-sync')
          )
        )
      ) ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-latest

    environment: testdev

    permissions:
      contents: read
      pull-requests: read
      issues: write
      id-token: write
      actions: write

    outputs:
      claude_response: ${{ steps.claude-generate-code.outputs.response }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Generation
        id: claude-generate-code
        uses: anthropics/claude-code-action@beta
        env:
          ANTHROPIC_API_KEY: <span class="math-inline">\{\{ secrets\.ANTHROPIC\_API\_KEY \}\}
with\:
direct\_prompt\: \|
Based on the following issue/comment\:
"</span>{{ github.event.comment.body || github.event.issue.body || github.event.review.body }}"
            Please generate the necessary code changes to address it.
            Provide the code in a single markdown code block.
            Focus on creating a small, self-contained change.
          allowed_tools: "Bash(npm install),Bash(npm run build),Bash(npm run test),Bash(npm run lint)"

      - name: Extract Claude's Generated Code
        id: extract-code
        run: |
          RAW_RESPONSE="${{ steps.claude-generate-code.outputs.response }}"
          echo "Raw Claude Response:"
          echo "<span class="math-inline">RAW\_RESPONSE"
GENERATED\_CODE\=</span>(echo "$RAW_RESPONSE" | sed -n '/```/,/```/p' | grep -v '```')

          if [ -z "$GENERATED_CODE" ]; then
            echo "::warning::No code block found in Claude's response. Exiting without creating PR."
            echo "has_code=false" >> $GITHUB_OUTPUT
          else
            echo "::notice::Code block successfully extracted."
            echo "$GENERATED_CODE" > generated_code.txt
            echo "has_code=true" >> $GITHUB_OUTPUT
          fi

      - name: Dispatch PR Creation Workflow
        if: steps.extract-code.outputs.has_code == 'true'
        uses: actions/github-script@v7
        id: dispatch-pr-creation
        with:
          script: |
            const fs = require('fs');
            const generatedCode = fs.readFileSync('generated_code.txt', 'utf8');

            const pr_number = '${{ github.event.pull_request.number || github.event.issue.number }}';
            const issue_or_pr_id = pr_number ? `#${pr_number}` : 'Unknown';

            let originalPrAuthor = '';
            if (context.eventName === 'issue_comment' || context.eventName === 'issues') {
              originalPrAuthor = context.payload.issue.user.login;
            } else if (context.eventName === 'pull_request_review_comment' || context.eventName === 'pull_request_review') {
              originalPrAuthor = context.payload.pull_request.user.login;
            }
            if (!originalPrAuthor) {
                originalPrAuthor = context.actor;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'claude-create-pr.yml',
              ref: context.ref,
              inputs: {
                pr_title: `feat(ai): Auto-generated changes for ${issue_or_pr_id}`,
                pr_body: `ðŸ¤– This Pull Request contains auto-generated code by Claude AI based on the prompt/issue ${issue_or_pr_id}.

---Generated Code---
\`\`\`
${generatedCode}
\`\`\`

---Claude's Full Response---
${process.env.RAW_CLAUDE_RESPONSE}
`, # This is line 117. The comma needs to go *after* the backtick.
                generated_code: generatedCode, # This would be line 118 or so depending on exact line wrapping
                source_issue_or_pr: pr_number,
                source_event_type: context.eventName,
                original_pr_author: originalPrAuthor
              }
            });
            console.log('Dispatched claude-create-pr.yml workflow.');
        env:
          RAW_CLAUDE_RESPONSE: ${{ steps.claude-generate-code.outputs.response }}